<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mnu.myblog.mapper.NoticeMapper">

    <!-- ================= ãƒ¦ãƒ¼ã‚¶ãƒ¼ ================= -->

    <!-- ãŠçŸ¥ã‚‰ã›ä¸€è¦§ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ -->
    <select id="selectNoticeList"
            parameterType="map"
            resultType="com.mnu.myblog.domain.NoticeDTO">
        SELECT
            notice_id   AS noticeId,
            title,
            content,
            image_path  AS imagePath,
            visible,
            pinned,
            views,
            check_count AS checkCount,
            created_at  AS createdAt
        FROM notice
        WHERE visible = 1
        <if test="keyword != null and keyword != ''">
            AND (
                title   LIKE CONCAT('%', #{keyword}, '%')
                OR content LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY pinned DESC, created_at DESC
    </select>

    <!-- â­ ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸æœ€æ–°ãŠçŸ¥ã‚‰ã› 3ä»¶ -->
    <select id="selectLatestNotices"
            resultType="com.mnu.myblog.domain.NoticeDTO">
        SELECT
            notice_id   AS noticeId,
            title,
            image_path  AS imagePath,
            pinned,
            created_at  AS createdAt
        FROM notice
        WHERE visible = 1
        ORDER BY pinned DESC, created_at DESC
        LIMIT 3
    </select>

    <!-- ãŠçŸ¥ã‚‰ã›è©³ç´° -->
    <select id="selectNotice"
            parameterType="long"
            resultType="com.mnu.myblog.domain.NoticeDTO">
        SELECT
            notice_id   AS noticeId,
            title,
            content,
            image_path  AS imagePath,
            visible,
            pinned,
            views,
            check_count AS checkCount,
            created_at  AS createdAt
        FROM notice
        WHERE notice_id = #{noticeId}
    </select>

    <!-- ================= ç®¡ç†è€… ================= -->

    <!-- ç®¡ç†è€…ãŠçŸ¥ã‚‰ã›ä¸€è¦§ -->
    <select id="selectAdminNoticeList"
            parameterType="map"
            resultType="com.mnu.myblog.domain.NoticeDTO">
        SELECT
            notice_id   AS noticeId,
            title,
            content,
            image_path  AS imagePath,
            visible,
            pinned,
            views,
            check_count AS checkCount,
            created_at  AS createdAt
        FROM notice
        <if test="keyword != null and keyword != ''">
            WHERE (
                title   LIKE CONCAT('%', #{keyword}, '%')
                OR content LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY pinned DESC, created_at DESC
    </select>

    <!-- ãŠçŸ¥ã‚‰ã›ä½œæˆ -->
    <insert id="insertNotice"
            parameterType="com.mnu.myblog.domain.NoticeDTO">
        INSERT INTO notice (
            title,
            content,
            image_path,
            visible,
            pinned
        )
        VALUES (
            #{title},
            #{content},
            #{imagePath},
            #{visible},
            #{pinned}
        )
    </insert>

    <!-- ãŠçŸ¥ã‚‰ã›å‰Šé™¤ -->
    <delete id="deleteNotice">
        DELETE FROM notice
        WHERE notice_id = #{noticeId}
    </delete>

    <!-- è¡¨ç¤º / éžè¡¨ç¤º åˆ‡æ›¿ -->
    <update id="toggleVisible">
        UPDATE notice
        SET visible = IF(visible = 1, 0, 1)
        WHERE notice_id = #{noticeId}
    </update>

    <!-- ðŸ“Œ PIN çŠ¶æ…‹æ›´æ–°ï¼ˆ0 / 1 æ˜Žç¤ºï¼‰ -->
    <update id="updatePinned">
        UPDATE notice
        SET pinned = #{pinned}
        WHERE notice_id = #{noticeId}
    </update>

    <!-- ================= ã‚«ã‚¦ãƒ³ãƒˆ ================= -->

    <update id="increaseViews">
        UPDATE notice
        SET views = views + 1
        WHERE notice_id = #{noticeId}
    </update>

    <update id="increaseCheckCount">
        UPDATE notice
        SET check_count = check_count + 1
        WHERE notice_id = #{noticeId}
    </update>

    <!-- ================= çµ±è¨ˆ ================= -->

    <select id="getNoticeStats"
            resultType="map">
        SELECT
            COUNT(*)         AS totalCount,
            SUM(views)       AS totalViews,
            SUM(check_count) AS totalChecks
        FROM notice
    </select>

</mapper>