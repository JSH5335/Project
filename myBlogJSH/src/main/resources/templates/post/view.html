<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Jo's Blog | è¨˜äº‹</title>

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/archive.css">
<link rel="stylesheet" href="/css/post.css">
<link rel="stylesheet" href="/css/post_comments.css">

<style>
.post-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
}

/* â— í´ë¦­ì€ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ pointer-events ì œê±° */
.like-disabled {
    background: #e5e7eb !important;
    color: #9ca3af !important;
}

/* ===== ì²¨ë¶€íŒŒì¼ ì¹´ë“œ ===== */
.post-attachment {
    margin: 22px 0;
    padding: 16px 18px;
    border-radius: 18px;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
}

.attachment-label {
    font-size: 13px;
    font-weight: 800;
    margin-bottom: 6px;
}

/* ===== ëŒ“ê¸€ ===== */
.comment-section {
    margin-top: 60px;
    background: #ffffff;
    border-radius: 24px;
    padding: 28px 32px;
    box-shadow: 0 20px 40px rgba(15,23,42,0.08);
}

.comment-title {
    font-size: 16px;
    font-weight: 800;
    margin-bottom: 18px;
}

.comment-form textarea {
    width: 100%;
    min-height: 90px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.comment-submit {
    margin-top: 10px;
    padding: 8px 18px;
    border-radius: 12px;
    border: none;
    background: #3b82f6;
    color: #fff;
    font-weight: 700;
}

.comment-item {
    padding: 16px 10px;
    border-bottom: 1px solid #e5e7eb;
}

.comment-item.deleted {
    color: #9ca3af;
    font-style: italic;
}

.comment-writer {
    font-weight: 700;
}

.comment-date {
    font-size: 12px;
    color: #64748b;
    margin-left: 6px;
}

/* ===== ëŒ“ê¸€ ì•¡ì…˜ ===== */
.comment-actions {
    margin-top: 8px;
    display: flex;
    gap: 12px;
}

.comment-btn {
    background: none;
    border: none;
    font-size: 12px;
    font-weight: 700;
    color: #64748b;
    cursor: pointer;
}

.comment-btn.delete {
    color: #dc2626;
}

.comment-btn.report {
    color: #f59e0b;
}

/* ===== ëŒ€ëŒ“ê¸€ ===== */
.reply-list {
    margin-top: 14px;
    padding-left: 20px;
}

.reply-item {
    padding: 10px 0;
    border-left: 2px solid #e5e7eb;
    padding-left: 14px;
}

.reply-writer {
    font-weight: 700;
    font-size: 13px;
}

.reply-date {
    font-size: 11px;
    color: #64748b;
    margin-left: 6px;
}

/* ===== ëŒ€ëŒ“ê¸€ ì‘ì„± ===== */
.reply-form {
    margin-top: 10px;
    padding-left: 20px;
    display: none;
}

.reply-form textarea {
    width: 100%;
    min-height: 70px;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
}

/* ===== âœ” ì»¤ìŠ¤í…€ ê²½ê³  ëª¨ë‹¬ ===== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modal {
    background: #ffffff;
    border-radius: 18px;
    padding: 24px 28px;
    width: 360px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    text-align: center;
}

.modal-title {
    font-size: 16px;
    font-weight: 800;
    margin-bottom: 10px;
}

.modal-desc {
    font-size: 14px;
    color: #475569;
    margin-bottom: 22px;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
}

.modal-btn {
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    cursor: pointer;
}

.modal-btn.cancel {
    background: #e5e7eb;
}

.modal-btn.confirm {
    background: #ef4444;
    color: #ffffff;
}

/* ===== ğŸ”” í† ìŠ¤íŠ¸ ===== */
.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 700;
    color: #ffffff;
    z-index: 10000;
    animation: fadeInOut 3s forwards;
}

.toast.success { background: #22c55e; }
.toast.error { background: #ef4444; }
.toast.warning { background: #f59e0b; }
.toast.info { background: #3b82f6; }

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(10px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; }
    100% { opacity: 0; }
}
</style>
</head>

<body th:classappend="${session.darkMode} ? ' dark' : ''">
<div class="layout">
<section class="main post-view-container">

<h1 class="post-title" th:text="${post.title}"></h1>

<div class="post-meta">
    <span th:text="${post.writerName}"></span>
    <span>Â·</span>
    <span th:text="${#temporals.format(post.createdAt,'yyyy.MM.dd HH:mm')}"></span>
    <span>Â· ğŸ’¬ <b th:text="${commentCount}">0</b></span>
    <span>&nbsp; â¤ï¸ <b th:text="${post.likeCount}">0</b></span>
</div>

<div class="post-attachment"
     th:if="${post.filePath != null and post.originalFileName != null}">
    <div class="attachment-label">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</div>
    <a th:href="@{/post/download/{postId}(postId=${post.postId})}"
       class="action-btn download"
       th:text="'â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ : ' + ${post.originalFileName}">
    </a>
</div>

<article class="post-content" th:text="${post.content}"></article>

<!-- âœ… ë²„íŠ¼ í•œ ì¤„ ìœ ì§€ -->
<div class="post-actions" th:if="${session.loginUser != null}">

    <!-- â¤ï¸ ì¢‹ì•„ìš” : ë¡œê·¸ì¸ ìœ ì € -->
    <form th:action="@{/post/like}" method="post">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <button type="submit"
                class="action-btn like"
                th:classappend="${liked} ? ' like-disabled' : ''">
            â¤ï¸ ã„ã„ã­
        </button>
    </form>

    <!-- âœï¸ ìˆ˜ì • / ğŸ—‘ ì‚­ì œ : ì‘ì„±ì or ê´€ë¦¬ì -->
    <a th:if="${session.loginUser.isAdmin() or session.loginUser.userId == post.writerId}"
       th:href="@{/post/edit/{id}(id=${post.postId})}"
       class="action-btn edit">âœï¸ ä¿®æ­£</a>

    <form th:if="${session.loginUser.isAdmin() or session.loginUser.userId == post.writerId}"
          th:action="@{/post/delete}" method="post">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <button type="submit" class="action-btn delete">ğŸ—‘ å‰Šé™¤</button>
    </form>

</div>

<section class="comment-section">
<div class="comment-title">
    ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ (<span th:text="${commentCount}">0</span>)
</div>

<form th:if="${session.loginUser != null}"
      th:action="@{/comment/write}"
      method="post"
      class="comment-form">
    <input type="hidden" name="postId" th:value="${post.postId}">
    <textarea name="content" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
    <button type="submit" class="comment-submit">ç™»éŒ²</button>
</form>

<div th:each="comment : ${commentList}"
     class="comment-item"
     th:classappend="${comment.deleted} ? ' deleted' : ''">

    <div>
        <span class="comment-writer" th:text="${comment.userName}"></span>
        <span class="comment-date"
              th:text="${#temporals.format(comment.createdAt,'yyyy.MM.dd HH:mm')}"></span>
    </div>

    <div th:if="${comment.deleted}">
    <span th:if="${comment.deletedBy == 'ADMIN'}">
        ç®¡ç†è€…ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
    </span>
    <span th:if="${comment.deletedBy == 'USER'}">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
    </span>
	</div>
	
	<form th:if="${session.loginUser.isAdmin() 
	              and comment.deleted 
	              and comment.deletedBy == 'ADMIN'}"
	      th:action="@{/admin/comment/restore}"
	      method="post">
	
	    <input type="hidden" name="commentId" th:value="${comment.commentId}">
	    <input type="hidden" name="postId" th:value="${post.postId}">
	
	    <button type="submit" class="comment-btn">
	        â™»ï¸ å¾©å…ƒ
	    </button>
	</form>
    <div th:if="${!comment.deleted}"
	     th:text="${comment.originalContent != null 
	              ? comment.originalContent 
	              : comment.content}">
	</div>
	<!-- ===== ëŒ€ëŒ“ê¸€ ëª©ë¡ ===== -->
	<div class="reply-list"
	     th:if="${!comment.deleted and comment.replyList != null and !#lists.isEmpty(comment.replyList)}">
	
	    <div th:each="reply : ${comment.replyList}"
		     class="reply-item"
		     th:classappend="${reply.deleted} ? ' deleted' : ''">
		
		    <div>
		        <span class="reply-writer" th:text="${reply.userName}"></span>
		        <span class="reply-date"
		              th:text="${#temporals.format(reply.createdAt,'yyyy.MM.dd HH:mm')}"></span>
		    </div>
		
		    <!-- ì‚­ì œëœ ëŒ€ëŒ“ê¸€ -->
		    <div th:if="${reply.deleted}">
			    <span th:if="${reply.deletedBy == 'ADMIN'}">
			        ç®¡ç†è€…ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
			    </span>
			    <span th:if="${reply.deletedBy == 'USER'}">
			        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
			    </span>
			</div>
		    <!-- ì •ìƒ ëŒ€ëŒ“ê¸€ -->
		    <div th:if="${!reply.deleted}"
			     th:text="${reply.originalContent != null 
			              ? reply.originalContent 
			              : reply.content}">
			</div>
		</div>
	</div>

	<div class="comment-actions"
     th:if="${session.loginUser != null and !comment.deleted}">

    <!-- ê´€ë¦¬ì SOFT DELETE -->
    <form th:if="${session.loginUser.isAdmin()}"
          th:action="@{/admin/comment/soft-delete}"
          method="post">
        <input type="hidden" name="commentId" th:value="${comment.commentId}">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <button type="submit" class="comment-btn delete">ğŸ—‘ å‰Šé™¤</button>
    </form>

    <!-- ê´€ë¦¬ì HARD DELETE -->
    <form th:if="${session.loginUser.isAdmin()}"
          th:action="@{/admin/comment/hard-delete}"
          method="post">
        <input type="hidden" name="commentId" th:value="${comment.commentId}">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <button type="submit" class="comment-btn delete">âŒ å®Œå…¨å‰Šé™¤</button>
    </form>

    <!-- íšŒì› ì‚­ì œ -->
    <form th:if="${!session.loginUser.isAdmin() and session.loginUser.userId == comment.userId}"
          th:action="@{/comment/delete}"
          method="post">
        <input type="hidden" name="commentId" th:value="${comment.commentId}">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <button type="submit" class="comment-btn delete">ğŸ—‘ å‰Šé™¤</button>
    </form>

    <!-- ë‹µê¸€ -->
    <button type="button"
            class="comment-btn reply-toggle"
            th:attr="data-target='reply-'+${comment.commentId}">
        â†© è¿”ä¿¡
    </button>

    <!-- ì‹ ê³  -->
    <form th:if="${!session.loginUser.isAdmin() and session.loginUser.userId != comment.userId}"
          th:action="@{/comment/report}"
          method="post"
          class="report-form">
        <input type="hidden" name="commentId" th:value="${comment.commentId}">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <input type="hidden" name="reason" value="ä¸é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆ">
        <button type="button"
                class="comment-btn report"
                onclick="openReportModal(this.form)">
            ğŸš¨ é€šå ±
        </button>
    </form>

</div>

    <form th:id="'reply-'+${comment.commentId}"
      class="reply-form"
      th:if="${!comment.deleted}"
      th:action="@{/comment/write}"
      method="post">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <input type="hidden" name="parentId" th:value="${comment.commentId}">
        <textarea name="content" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
        <button type="submit" class="comment-submit">è¿”ä¿¡</button>
    </form>

</div>
</section>

</section>
</div>

<!-- âœ” ì‹ ê³  ê²½ê³  ëª¨ë‹¬ -->
<div id="reportModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆé€šå ±</div>
        <div class="modal-desc">ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€šå ±ã—ã¾ã™ã‹ï¼Ÿ</div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeReportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="modal-btn confirm" onclick="submitReport()">é€šå ±ã™ã‚‹</button>
        </div>
    </div>
</div>

<!-- ğŸ”” í† ìŠ¤íŠ¸ -->
<div th:if="${toastMsg}"
     class="toast"
     th:text="${toastMsg}"
     th:classappend="' ' + ${toastType}">
</div>

<script>
let reportForm = null;

function openReportModal(form) {
    reportForm = form;
    document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
    reportForm = null;
    document.getElementById('reportModal').style.display = 'none';
}

function submitReport() {
    if (reportForm) {
        reportForm.submit();
    }
}
</script>

<script>
document.querySelectorAll('.reply-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        if (target) {
            target.style.display =
                target.style.display === 'none' || target.style.display === ''
                ? 'block'
                : 'none';
        }
    });
});
</script>
<!-- ğŸ“„ ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
<a href="/archive" class="floating-list-btn">
    ğŸ“„ ä¸€è¦§ã¸
</a>
</body>
</html>