<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ä¼šå“¡ç®¡ç† | ç®¡ç†è€…</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/admin_user.css">

    <style>
        .toast {
            position: fixed;
    		bottom: 20px;
    		right: 20px;

            /* ğŸ”¥ ë°°ë„ˆí™” ë°©ì§€ í•µì‹¬ */
            display: inline-flex;
            align-items: center;

            max-width: 260px;
            max-height: 64px;
            height: auto;
            width: auto;

            padding: 8px 14px;
            border-radius: 6px;

            font-size: 12px;
            font-weight: 700;
            line-height: 1.35;

            color: #ffffff;
            background-clip: padding-box;

            white-space: normal;
            word-break: break-word;

            z-index: 9999;
            opacity: 0.95;

            box-shadow: 0 8px 20px rgba(0,0,0,0.22);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast.success { background-color: #34d399; }
        .toast.warning { background-color: #f87171; }
        .toast.error   { background-color: #ef4444; }

        .toast.hide {
            transform: translateX(120%);
            opacity: 0;
        }
    </style>
</head>

<body th:classappend="${session.darkMode == true} ? ' dark' : ''">

<div class="layout">

    <div th:replace="admin/fragments/sidebar :: adminSidebar"></div>

    <section class="main">

        <div class="header">
            <h1>ğŸ‘¥ ä¼šå“¡ç®¡ç†</h1>
        </div>

        <div class="card">

            <table class="admin-table">
                <thead>
                <tr>
                    <th>No</th>
                    <th>ID</th>
                    <th>åå‰</th>
                    <th>é›»è©±ç•ªå·</th>
                    <th>æ¨©é™</th>
                    <th>ç™»éŒ²æ—¥</th>
                    <th>çŠ¶æ…‹</th>
                    <th>ç®¡ç†</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="user, stat : ${userList}"
                    th:classappend="${user.role == 'ADMIN'} ? 'admin-row' : ''">

                    <td th:text="${stat.count}"></td>

                    <td>
                        <span th:if="${user.role == 'ADMIN'}" class="admin-crown">ğŸ‘‘</span>
                        <span th:text="${user.userId}"></span>
                    </td>

                    <td th:text="${user.userName}"></td>
                    <td th:text="${user.phone}"></td>

                    <td>
                        <span th:text="${user.role}"
                              th:classappend="${user.role == 'ADMIN'} ? 'role-admin' : 'role-user'">
                        </span>
                    </td>

                    <td th:text="${#temporals.format(user.createdAt,'yyyy.MM.dd')}"></td>

                    <td>
                        <span th:if="${user.banned == true}" class="status-banned">åœæ­¢</span>
                        <span th:if="${user.banned != true}" class="status-active">æœ‰åŠ¹</span>
                    </td>

                    <td>
                        <span th:if="${user.userId == session.loginUser.userId}"
                              class="self-label">
                            æœ¬äºº
                        </span>

                        <form th:if="${user.userId != session.loginUser.userId}"
                              method="post"
                              action="/admin/users/role"
                              class="inline-form">
                            <input type="hidden" name="userId" th:value="${user.userId}">
                            <input type="hidden" name="role"
                                   th:value="${user.role == 'ADMIN' ? 'USER' : 'ADMIN'}">
                            <button type="submit"
                                    th:text="${user.role == 'ADMIN'} ? 'ç®¡ç†è€…è§£é™¤' : 'ç®¡ç†è€…æŒ‡å®š'"
                                    th:class="${user.role == 'ADMIN'} ? 'btn-admin-remove' : 'btn-admin-add'">
                            </button>
                        </form>

                        <form th:if="${user.banned != true}"
                              method="post"
                              action="/admin/users/ban"
                              class="inline-form btn-action">
                            <input type="hidden" name="userId" th:value="${user.userId}">
                            <input type="hidden" name="reason" value="ç®¡ç†è€…ã«ã‚ˆã‚‹åœæ­¢">
                            <button type="submit" class="btn-ban">åœæ­¢</button>
                        </form>

                        <form th:if="${user.banned == true}"
                              method="post"
                              action="/admin/users/unban"
                              class="inline-form btn-action">
                            <input type="hidden" name="userId" th:value="${user.userId}">
                            <button type="submit" class="btn-unban">åœæ­¢è§£é™¤</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

        </div>

        <footer>
            ç®¡ç†è€…ãƒšãƒ¼ã‚¸ Â· Jo's Developer Blog
        </footer>

    </section>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const btnForms = document.querySelectorAll('.btn-action');

    btnForms.forEach(form => {
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(form);

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });

                if (res.ok) {
                    const isBan = form.querySelector('.btn-ban') !== null;
                    showToast(
                        isBan ? 'ä¼šå“¡ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚' : 'ä¼šå“¡ã®åœæ­¢ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚',
                        isBan ? 'warning' : 'success'
                    );
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                }
            } catch (err) {
                showToast('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚', 'error');
            }
        });
    });

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
});
</script>

</body>
</html>
