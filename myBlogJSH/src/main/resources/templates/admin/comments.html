<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€… | ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†</title>

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/admin.css">
<link rel="stylesheet" href="/css/admin_comments.css">

<style>
.reply-row td.comment-content {
    padding-left: 24px;
    background: #f9fafb;
}

.reply-badge {
    font-size: 11px;
    color: #6b7280;
    margin-right: 6px;
}

.deleted-row {
    background: #fef2f2;
}

.deleted-label {
    display: inline-block;
    font-size: 11px;
    font-weight: 700;
    color: #b91c1c;
    background: #fee2e2;
    padding: 2px 6px;
    border-radius: 6px;
    margin-right: 6px;
}

.comment-content {
    text-align: center;
}

.btn-hard-delete {
    background-color: #7f1d1d !important;
}
.btn-hard-delete:hover {
    background-color: #991b1b !important;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 24px;
}

.pagination a {
    min-width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    text-decoration: none;
    background: #f3f4f6;
    color: #111827;
    font-size: 13px;
    font-weight: 600;
}

.pagination a:hover {
    background: #e5e7eb;
}

.pagination a.active {
    background: #2563eb;
    color: #ffffff;
}

.pagination a.disabled {
    pointer-events: none;
    background: #f9fafb;
    color: #9ca3af;
}

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modal {
    width: 420px;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    padding: 26px;
    text-align: center;
}

.modal-icon {
    font-size: 42px;
    margin-bottom: 10px;
}

.modal-title {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 8px;
}

.modal-desc {
    font-size: 14px;
    color: #4b5563;
    margin-bottom: 20px;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.modal-actions button {
    min-width: 90px;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    font-weight: 700;
    cursor: pointer;
}

.btn-cancel {
    background: #e5e7eb;
}

.btn-confirm {
    color: #fff;
}

.btn-confirm.warn {
    background: #f59e0b;
}

.btn-confirm.danger {
    background: #dc2626;
}
</style>
</head>

<body th:classappend="${session.darkMode == true} ? ' dark' : ''">

<div class="layout">

    <div th:replace="admin/fragments/sidebar :: adminSidebar"></div>

    <section class="main">

        <div class="header">
            <h1>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†</h1>
            <p class="sub-text">ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç®¡ç†ã—ã¾ã™</p>
        </div>

        <div class="admin-table-card">

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹</th>
                        <th>ä½œæˆè€…</th>
                        <th>å…ƒè¨˜äº‹</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>ç®¡ç†</th>
                    </tr>
                </thead>

                <tbody>
                    <tr th:each="comment : ${commentList}"
                        th:classappend="${comment.deleted} ? 'deleted-row' : ''">

                        <td th:text="${comment.commentId}"></td>

                        <td class="comment-content">
                            <span th:if="${comment.deleted}"
                                  class="deleted-label"
                                  th:text="${comment.deletedBy == 'ADMIN'
                                      ? 'ç®¡ç†è€…ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸ'
                                      : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸ'}">
                            </span>

                            <span th:if="${comment.depth == 1}" class="reply-badge">â†³ è¿”ä¿¡</span>

                            <span th:if="${!comment.deleted}"
                                  th:text="${comment.content}"></span>
                        </td>

                        <td th:text="${comment.userName}"></td>

                        <td>
                            <a th:href="@{/post/view/{id}(id=${comment.postId})}" target="_blank">
                                è¡¨ç¤º
                            </a>
                        </td>

                        <td th:text="${#temporals.format(comment.createdAt,'yyyy-MM-dd HH:mm')}"></td>

                        <td>
                            <div th:if="${!comment.deleted}"
                                 style="display:flex; justify-content:center; gap:6px;">

                                <form th:action="@{/admin/comments/delete}"
                                      method="post"
                                      class="confirm-form"
                                      data-type="soft">
                                    <input type="hidden" name="commentId" th:value="${comment.commentId}">
                                    <input type="hidden" name="page" th:value="${currentPage}">
                                    <button type="submit" class="btn btn-delete">å‰Šé™¤</button>
                                </form>

                                <form th:action="@{/admin/comments/hard-delete}"
                                      method="post"
                                      class="confirm-form"
                                      data-type="hard">
                                    <input type="hidden" name="commentId" th:value="${comment.commentId}">
                                    <input type="hidden" name="page" th:value="${currentPage}">
                                    <button type="submit"
                                            class="btn btn-delete btn-hard-delete">
                                        å®Œå…¨å‰Šé™¤
                                    </button>
                                </form>

                            </div>

                            <div th:if="${comment.deleted}"
                                 style="display:flex; justify-content:center; gap:6px;">

                                <form th:action="@{/admin/comments/restore}"
                                      method="post">
                                    <input type="hidden" name="commentId"
                                           th:value="${comment.commentId}">
                                    <button type="submit" class="btn btn-restore">
                                        â™» å¾©å…ƒ
                                    </button>
                                </form>

                                <form th:action="@{/admin/comments/hard-delete}"
                                      method="post"
                                      class="confirm-form"
                                      data-type="hard">
                                    <input type="hidden" name="commentId"
                                           th:value="${comment.commentId}">
                                    <button type="submit"
                                            class="btn btn-delete btn-hard-delete">
                                        å®Œå…¨å‰Šé™¤
                                    </button>
                                </form>

                            </div>
                        </td>

                    </tr>
                </tbody>
            </table>

            <div class="pagination" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 0}"
                   th:href="@{/admin/comments(page=${currentPage - 1})}">â€¹</a>

                <a th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                   th:href="@{/admin/comments(page=${i})}"
                   th:text="${i + 1}"
                   th:classappend="${i == currentPage} ? ' active' : ''"></a>

                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/admin/comments(page=${currentPage + 1})}">â€º</a>
            </div>

        </div>

        <footer>
            ç®¡ç†è€…ãƒšãƒ¼ã‚¸ Â· Jo's Developer Blog
        </footer>

    </section>

</div>

<div class="modal-backdrop" id="confirmModal">
    <div class="modal">
        <div class="modal-icon" id="modalIcon">âš ï¸</div>
        <div class="modal-title" id="modalTitle">ç¢ºèª</div>
        <div class="modal-desc" id="modalDesc"></div>

        <div class="modal-actions">
            <button class="btn-cancel" id="modalCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="modalConfirmBtn" class="btn-confirm">å‰Šé™¤</button>
        </div>
    </div>
</div>

<!-- âœ… ì—¬ê¸°ë§Œ êµì²´ëœ JS -->
<script>
let targetForm = null;

document.querySelectorAll('.confirm-form').forEach(form => {
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        targetForm = this;

        const type = this.dataset.type;
        const modal = document.getElementById('confirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const desc = document.getElementById('modalDesc');
        const confirmBtn = document.getElementById('modalConfirmBtn');

        if (type === 'hard') {
            icon.textContent = 'ğŸš¨';
            title.textContent = 'å®Œå…¨å‰Šé™¤';
            desc.textContent = 'ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚';
            confirmBtn.className = 'btn-confirm danger';
            confirmBtn.textContent = 'å®Œå…¨å‰Šé™¤';
        } else {
            icon.textContent = 'âš ï¸';
            title.textContent = 'å‰Šé™¤ç¢ºèª';
            desc.textContent = 'ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
            confirmBtn.className = 'btn-confirm warn';
            confirmBtn.textContent = 'å‰Šé™¤';
        }

        modal.style.display = 'flex';
    });
});

document.getElementById('modalCancelBtn').addEventListener('click', () => {
    document.getElementById('confirmModal').style.display = 'none';
    targetForm = null;
});

document.getElementById('modalConfirmBtn').addEventListener('click', () => {
    if (targetForm) targetForm.submit();
});
</script>

</body>
</html>