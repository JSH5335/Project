<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>会員登録 | Jo's Blog</title>

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/join.css">
</head>

<body th:classappend="${session.darkMode} ? ' dark' : ''">

<div class="layout">
    <section class="main join-page">

        <div class="join-card" id="joinCard">

            <!-- 🔵 上部ロゴ -->
            <div class="join-logo">
                <img src="/images/logo.png" alt="Jo's Blog ロゴ">
            </div>

            <h1 class="join-title" id="joinTitle">会員登録</h1>
            <p class="join-desc" id="joinDesc">
                Jo's Developer Blogへようこそ
            </p>

            <!-- 🔢 ステップ表示 -->
            <div class="join-steps">
                <div class="step active" id="step1">1<br><span>情報入力</span></div>
                <div class="step" id="step2">2<br><span>電話認証</span></div>
                <div class="step" id="step3">3<br><span>完了</span></div>
            </div>

            <form method="post" action="/register" id="registerForm">

                <input type="text" name="userId" placeholder="ユーザーID" required>
                <input type="password" name="userPw" placeholder="パスワード" required>
                <input type="text" name="userName" placeholder="名前" required>

                <input type="text" id="phone" name="phone"
                       placeholder="電話番号 (例: 09012345678)" required>

                <button type="button" class="btn-auth" onclick="sendSms()">
                    認証番号取得
                </button>

                <input type="text" id="smsCode" placeholder="認証番号入力">

                <button type="button" class="btn-auth-confirm" onclick="verifySms()">
                    認証確認
                </button>

                <button type="submit" id="registerBtn"
                        class="btn-submit" disabled>
                    会員登録
                </button>

                <div class="back-home">
                    <button type="button"
                            class="btn-submit btn-back"
                            onclick="location.href='/'">
                        戻る
                    </button>
                </div>

            </form>

        </div>

    </section>
</div>

<div id="toast"
     th:if="${toastMsg}"
     th:text="${toastMsg}"
     th:class="'toast ' + ${toastType}">
</div>

<script>
let smsVerified = false;

function setStep(step) {
    document.getElementById("step1").classList.remove("active");
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step3").classList.remove("active");
    document.getElementById("step" + step).classList.add("active");
}

function sendSms() {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) {
        showToast("電話番号を入力してください。", "error");
        return;
    }

    fetch("/sms/send", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "phone=" + encodeURIComponent(phone)
    }).then(() => {
        showToast("認証番号が送信されました。", "success");
        setStep(2);
    });
}

function verifySms() {
    const phone = document.getElementById("phone").value.trim();
    const code = document.getElementById("smsCode").value.trim();

    if (!code) {
        showToast("認証番号を入力してください。", "error");
        return;
    }

    fetch("/sms/verify", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "phone=" + encodeURIComponent(phone) + "&code=" + encodeURIComponent(code)
    })
    .then(res => res.text())
    .then(result => {
        if (result === "success") {
            smsVerified = true;
            showToast("電話番号認証が完了しました。", "success");
            document.getElementById("registerBtn").disabled = false;
            document.getElementById("registerBtn").classList.add("active");
            setStep(2);
        } else {
            showToast("認証番号が正しくありません。", "error");
        }
    });
}

document.getElementById("registerForm").addEventListener("submit", function (e) {
    if (!smsVerified) {
        e.preventDefault();
        showToast("電話番号認証を完了してください。", "error");
        return;
    }

    setStep(3);
    document.getElementById("joinTitle").innerText = "会員登録完了";
    document.getElementById("joinDesc").innerText =
        "会員登録がほぼ完了しました。少々お待ちください 🙂";
});

function showToast(msg, type) {
    const toast = document.createElement("div");
    toast.className = "toast " + type;
    toast.innerText = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>

</body>
</html>